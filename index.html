<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>脊神经解剖学交互游戏</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0070c0',
                        secondary: '#00a0e9',
                        accent: '#ff6b6b',
                        neutral: '#f0f4f8',
                        dark: '#2c3e50',
                        success: '#28a745',
                        danger: '#dc3545',
                        warning: '#ffc107',
                        info: '#17a2b8'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .hover-scale {
                @apply transition-all duration-300;
            }
            .hover-scale:hover {
                transform: scale(1.03);
            }
            .anatomy-area {
                @apply cursor-pointer transition-all duration-300 border-2 border-transparent;
            }
            .anatomy-area:hover {
                @apply border-primary bg-blue-50 bg-opacity-50;
            }
            .anatomy-area.active {
                @apply border-accent bg-red-50 bg-opacity-50;
            }
            .quiz-option {
                @apply p-3 border border-gray-300 rounded-lg cursor-pointer transition-all duration-300;
            }
            .quiz-option:hover {
                @apply bg-blue-50 border-primary;
            }
            .quiz-option.correct {
                @apply bg-green-100 border-success;
            }
            .quiz-option.incorrect {
                @apply bg-red-100 border-danger;
            }
            .progress-bar {
                @apply h-2 bg-gray-200 rounded-full overflow-hidden;
            }
            .progress-value {
                @apply h-full bg-primary transition-all duration-500 ease-out;
            }
        }
    </style>
</head>
<body class="bg-neutral min-h-screen font-sans text-dark">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-brain text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">脊神经解剖学交互游戏</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                    <span class="font-semibold">得分:</span>
                    <span id="score" class="ml-1">0</span>/<span id="total">6</span>
                </div>
                <div class="w-32">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>进度</span>
                        <span id="progress-text">1/6</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-bar" class="progress-value" style="width: 16.67%"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 游戏开始界面 -->
        <section id="start-screen" class="flex flex-col items-center justify-center py-10">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl w-full hover-scale">
                <div class="text-center mb-6">
                    <i class="fa fa-brain text-primary text-5xl mb-4"></i>
                    <h2 class="text-2xl font-bold text-primary mb-2">欢迎来到脊神经解剖学交互游戏</h2>
                    <p class="text-gray-600">测试你对周围神经系统脊神经的知识掌握程度</p>
                </div>
                <div class="space-y-4 mb-6">
                    <div class="flex items-start">
                        <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mt-1 mr-3 flex-shrink-0">1</div>
                        <p>本游戏包含6道关于脊神经的测试题，包括选择题、填空题和识图题</p>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mt-1 mr-3 flex-shrink-0">2</div>
                        <p>每道题答对得1分，答错不扣分</p>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mt-1 mr-3 flex-shrink-0">3</div>
                        <p>完成所有题目后可以查看得分和错题回顾</p>
                    </div>
                </div>
                <div class="text-center">
                    <button id="start-btn" class="bg-primary hover:bg-secondary text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
                        开始游戏
                    </button>
                </div>
            </div>
        </section>

        <!-- 游戏界面 -->
        <section id="game-screen" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="question-number" class="text-lg font-bold text-primary">问题 1/6</h2>
                    <div class="text-sm text-gray-500">
                        <span id="timer">00:00</span>
                    </div>
                </div>
                <div id="question-container" class="mb-6">
                    <!-- 问题内容将通过JavaScript动态插入 -->
                </div>
                <div id="answer-container" class="space-y-3">
                    <!-- 答案选项将通过JavaScript动态插入 -->
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-primary mb-4">解剖图</h3>
                        <div id="anatomy-image-container" class="relative">
                            <!-- 解剖图将通过JavaScript动态插入 -->
                            <div id="anatomy-image" class="w-full h-auto rounded-lg overflow-hidden">
                                <!-- 解剖图内容 -->
                            </div>
                            <div id="image-zoom-controls" class="absolute bottom-4 right-4 flex space-x-2">
                                <button id="zoom-in" class="bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">
                                    <i class="fa fa-search-plus text-primary"></i>
                                </button>
                                <button id="zoom-out" class="bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">
                                    <i class="fa fa-search-minus text-primary"></i>
                                </button>
                                <button id="zoom-reset" class="bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-md hover:bg-gray-100 transition-all">
                                    <i class="fa fa-refresh text-primary"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-primary mb-4">提示</h3>
                        <div id="hint-container" class="text-gray-700 text-sm">
                            <!-- 提示内容将通过JavaScript动态插入 -->
                        </div>
                        <div class="mt-6">
                            <button id="next-btn" class="w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg hidden">
                                下一题
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 结果界面 -->
        <section id="result-screen" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 max-w-3xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-primary mb-2">游戏结束</h2>
                    <div class="text-6xl font-bold text-primary mb-4">
                        <span id="final-score">0</span>/<span id="final-total">6</span>
                    </div>
                    <p id="result-message" class="text-lg text-gray-700"></p>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-primary mb-4">错题回顾</h3>
                    <div id="review-container" class="space-y-6">
                        <!-- 错题回顾将通过JavaScript动态插入 -->
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="restart-btn" class="bg-primary hover:bg-secondary text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
                        重新开始
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white shadow-inner mt-10 py-4">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>© 2025 脊神经解剖学交互游戏 | 为解剖学教师和学生设计</p>
        </div>
    </footer>

    <!-- 答题反馈弹窗 -->
    <div id="feedback-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" id="modal-overlay"></div>
        <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4 z-10 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="text-center">
                <div id="feedback-icon" class="text-5xl mb-4"></div>
                <h3 id="feedback-title" class="text-xl font-bold mb-2"></h3>
                <p id="feedback-message" class="text-gray-700 mb-6"></p>
                <button id="feedback-close" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        // 题目数据
        const questions = [
            {
                id: 1,
                type: "multiple-choice",
                question: "人体共有多少对脊神经？",
                options: ["28对", "31对", "33对", "35对"],
                correctAnswer: 1,
                explanation: "人体共有31对脊神经，包括8对颈神经、12对胸神经、5对腰神经、5对骶神经和1对尾神经。",
                hint: "脊神经的数量与脊髓节段相对应，记住颈、胸、腰、骶、尾的数量总和。",
                image: "https://p26-doubao-search-sign.byteimg.com/tos-cn-i-be4g95zd3a/1678150701618954250~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776934044&x-signature=vcJ%2BCVpoHXMUqbwj5A2fMQFbQrQ%3D",
                imageType: "general"
            },
            {
                id: 2,
                type: "multiple-choice",
                question: "以下哪项不属于脊神经的纤维成分？",
                options: ["躯体感觉纤维", "躯体运动纤维", "内脏感觉纤维", "自主神经纤维"],
                correctAnswer: 3,
                explanation: "脊神经含有四种纤维成分：躯体感觉纤维、躯体运动纤维、内脏感觉纤维和内脏运动纤维。自主神经纤维是内脏运动纤维的一部分，不是独立的纤维成分。",
                hint: "回忆脊神经的四种基本纤维成分，注意区分相似但不同的术语。",
                image: "https://p26-doubao-search-sign.byteimg.com/labis/e928074e52bfcde579392db69dad5cc7~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776934044&x-signature=VFN2C1wqe77ac4vffKFuv%2BCRZ5Q%3D",
                imageType: "cross-section"
            },
            {
                id: 3,
                type: "fill-blank",
                question: "脊神经出椎间孔后立即分为前支、后支、脊膜支和______。",
                correctAnswer: "交通支",
                explanation: "脊神经出椎间孔后立即分为前支、后支、脊膜支和交通支。交通支是连于脊神经与交感干之间的细支。",
                hint: "这个分支与交感神经系统有关，连接脊神经与交感干。",
                image: "https://p26-doubao-search-sign.byteimg.com/labis/5eafcbbc061239fc0b233b7cf3b245b4~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776934044&x-signature=o3zNFMRGR7%2FW5XmmJeN9sEqmtrU%3D",
                imageType: "branch"
            },
            {
                id: 4,
                type: "anatomy-identification",
                question: "请指出图中标记为C5-C8的神经丛是：",
                options: ["颈丛", "臂丛", "腰丛", "骶丛"],
                correctAnswer: 1,
                explanation: "臂丛由第5～8颈神经前支和第1胸神经前支的大部分组成，主要分布于上肢和胸背部的皮肤和肌肉。",
                hint: "这个神经丛主要支配上肢，由C5-T1神经组成。",
                image: "https://p11-doubao-search-sign.byteimg.com/tos-cn-i-qvj2lq49k0/d78b33896fb34dd98c89397413fd1559~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776934044&x-signature=0ebNsls%2Bph83ZaVk0PACsonlPks%3D",
                imageType: "plexus",
                hotspots: [
                    { id: "cervical", label: "颈丛", coordinates: { x: 20, y: 30 }, correct: false },
                    { id: "brachial", label: "臂丛", coordinates: { x: 30, y: 40 }, correct: true },
                    { id: "lumbar", label: "腰丛", coordinates: { x: 50, y: 60 }, correct: false },
                    { id: "sacral", label: "骶丛", coordinates: { x: 60, y: 70 }, correct: false }
                ]
            },
            {
                id: 5,
                type: "multiple-choice",
                question: "以下哪种神经损伤会导致'垂腕症'？",
                options: ["尺神经", "正中神经", "桡神经", "腋神经"],
                correctAnswer: 2,
                explanation: "桡神经损伤会导致'垂腕症'，表现为腕关节不能伸直，手指不能伸直，拇指不能外展等症状。",
                hint: "这条神经主要支配前臂伸肌，损伤后会影响手腕的伸展功能。",
                image: "https://p26-doubao-search-sign.byteimg.com/labis/3711155a508acb96fd7a24ff1cb26c70~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776934044&x-signature=YM1XRmxB9cQ6J76koVnuQRcrQ1k%3D",
                imageType: "pathology"
            },
            {
                id: 6,
                type: "anatomy-identification",
                question: "请指出图中支配膈肌的神经是：",
                options: ["迷走神经", "膈神经", "肋间神经", "副神经"],
                correctAnswer: 1,
                explanation: "膈神经是颈丛的重要分支，支配膈肌的运动，同时传导胸膜、心包和部分腹膜的感觉冲动。",
                hint: "这条神经从颈丛发出，下行穿过胸腔支配膈肌。",
                image: "https://p26-doubao-search-sign.byteimg.com/labis/80bd2e80c6d5483eb0dec1475c47a0cd~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1776934044&x-signature=xWh9fIeXBmOcz62dtjbPjMWviGM%3D",
                imageType: "distribution",
                hotspots: [
                    { id: "vagus", label: "迷走神经", coordinates: { x: 40, y: 30 }, correct: false },
                    { id: "phrenic", label: "膈神经", coordinates: { x: 45, y: 40 }, correct: true },
                    { id: "intercostal", label: "肋间神经", coordinates: { x: 50, y: 50 }, correct: false },
                    { id: "accessory", label: "副神经", coordinates: { x: 35, y: 35 }, correct: false }
                ]
            }
        ];

        // 游戏状态
        let currentQuestionIndex = 0;
        let score = 0;
        let answeredQuestions = [];
        let startTime;
        let timerInterval;
        let zoomLevel = 1;
        let selectedHotspot = null;

        // DOM元素
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const nextBtn = document.getElementById('next-btn');
        const questionNumber = document.getElementById('question-number');
        const questionContainer = document.getElementById('question-container');
        const answerContainer = document.getElementById('answer-container');
        const hintContainer = document.getElementById('hint-container');
        const anatomyImage = document.getElementById('anatomy-image');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');
        const scoreElement = document.getElementById('score');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const timerElement = document.getElementById('timer');
        const finalScoreElement = document.getElementById('final-score');
        const finalTotalElement = document.getElementById('final-total');
        const resultMessageElement = document.getElementById('result-message');
        const reviewContainer = document.getElementById('review-container');
        const feedbackModal = document.getElementById('feedback-modal');
        const modalContent = document.getElementById('modal-content');
        const modalOverlay = document.getElementById('modal-overlay');
        const feedbackIcon = document.getElementById('feedback-icon');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackMessage = document.getElementById('feedback-message');
        const feedbackClose = document.getElementById('feedback-close');

        // 初始化游戏
        function initGame() {
            currentQuestionIndex = 0;
            score = 0;
            answeredQuestions = [];
            scoreElement.textContent = score;
            progressText.textContent = `${currentQuestionIndex + 1}/${questions.length}`;
            progressBar.style.width = `${(currentQuestionIndex + 1) / questions.length * 100}%`;
            loadQuestion(currentQuestionIndex);
            startTimer();
        }

        // 加载问题
        function loadQuestion(index) {
            const question = questions[index];
            questionNumber.textContent = `问题 ${index + 1}/${questions.length}`;
            questionContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">${question.question}</h3>`;
            answerContainer.innerHTML = '';
            hintContainer.innerHTML = `<p>${question.hint}</p>`;
            
            // 加载图片
            loadAnatomyImage(question);
            
            // 根据题目类型生成不同的答案界面
            switch(question.type) {
                case 'multiple-choice':
                    createMultipleChoiceOptions(question);
                    break;
                case 'fill-blank':
                    createFillBlankInput(question);
                    break;
                case 'anatomy-identification':
                    createAnatomyIdentification(question);
                    break;
            }
            
            nextBtn.classList.add('hidden');
        }

        // 加载解剖图
        function loadAnatomyImage(question) {
            anatomyImage.innerHTML = '';
            const img = document.createElement('img');
            img.src = question.image;
            img.alt = `解剖图 ${question.id}`;
            img.className = 'w-full h-auto transition-transform duration-300';
            img.style.transform = `scale(${zoomLevel})`;
            anatomyImage.appendChild(img);
            
            // 如果是解剖识别题，添加热点
            if (question.type === 'anatomy-identification' && question.hotspots) {
                question.hotspots.forEach(hotspot => {
                    const hotspotElement = document.createElement('div');
                    hotspotElement.id = hotspot.id;
                    hotspotElement.className = 'anatomy-area absolute rounded-full w-8 h-8 flex items-center justify-center text-white font-bold text-xs';
                    hotspotElement.style.left = `${hotspot.coordinates.x}%`;
                    hotspotElement.style.top = `${hotspot.coordinates.y}%`;
                    hotspotElement.style.backgroundColor = 'rgba(0, 112, 192, 0.7)';
                    hotspotElement.dataset.correct = hotspot.correct;
                    hotspotElement.textContent = hotspot.label.charAt(0);
                    
                    // 添加提示
                    hotspotElement.title = hotspot.label;
                    
                    // 添加点击事件
                    hotspotElement.addEventListener('click', () => selectHotspot(hotspotElement, hotspot));
                    
                    anatomyImage.appendChild(hotspotElement);
                });
            }
        }

        // 创建选择题选项
        function createMultipleChoiceOptions(question) {
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full border border-gray-400 flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                        </div>
                        <span>${option}</span>
                    </div>
                `;
                
                optionElement.addEventListener('click', () => checkMultipleChoiceAnswer(question, index, optionElement));
                answerContainer.appendChild(optionElement);
            });
        }

        // 创建填空题输入框
        function createFillBlankInput(question) {
            const inputContainer = document.createElement('div');
            inputContainer.className = 'flex items-center space-x-2';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent';
            input.placeholder = '请输入答案';
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'bg-primary hover:bg-secondary text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 whitespace-nowrap';
            submitBtn.textContent = '提交';
            
            submitBtn.addEventListener('click', () => checkFillBlankAnswer(question, input.value.trim(), input, submitBtn));
            
            inputContainer.appendChild(input);
            inputContainer.appendChild(submitBtn);
            answerContainer.appendChild(inputContainer);
        }

        // 创建解剖识别题
        function createAnatomyIdentification(question) {
            const instruction = document.createElement('p');
            instruction.className = 'mb-4 text-gray-700';
            instruction.textContent = '请点击图中相应位置，然后选择正确答案：';
            
            answerContainer.appendChild(instruction);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'space-y-2';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full border border-gray-400 flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                        </div>
                        <span>${option}</span>
                    </div>
                `;
                
                optionElement.addEventListener('click', () => {
                    if (selectedHotspot) {
                        checkAnatomyIdentificationAnswer(question, index, optionElement);
                    } else {
                        showFeedback('请先点击图中位置', 'warning');
                    }
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            answerContainer.appendChild(optionsContainer);
        }

        // 检查选择题答案
        function checkMultipleChoiceAnswer(question, selectedIndex, optionElement) {
            const isCorrect = selectedIndex === question.correctAnswer;
            
            // 禁用所有选项
            const options = answerContainer.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.removeEventListener('click', arguments.callee);
                option.style.pointerEvents = 'none';
            });
            
            // 标记正确和错误的选项
            optionElement.classList.add(isCorrect ? 'correct' : 'incorrect');
            
            if (!isCorrect) {
                options[question.correctAnswer].classList.add('correct');
            }
            
            // 更新得分
            if (isCorrect) {
                score++;
                scoreElement.textContent = score;
            }
            
            // 记录答题结果
            answeredQuestions.push({
                question: question,
                userAnswer: selectedIndex,
                isCorrect: isCorrect
            });
            
            // 显示解析
            const explanation = document.createElement('div');
            explanation.className = 'mt-4 p-3 bg-blue-50 rounded-lg text-sm';
            explanation.innerHTML = `<strong>解析：</strong>${question.explanation}`;
            answerContainer.appendChild(explanation);
            
            // 显示下一题按钮
            nextBtn.classList.remove('hidden');
            
            // 显示反馈
            showFeedback(isCorrect ? '回答正确！' : '回答错误', isCorrect ? 'success' : 'error');
        }

        // 检查填空题答案
        function checkFillBlankAnswer(question, userAnswer, input, submitBtn) {
            // 禁用输入和提交按钮
            input.disabled = true;
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            
            // 检查答案（不区分大小写）
            const isCorrect = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
            
            // 标记输入框
            input.classList.add(isCorrect ? 'border-success' : 'border-danger');
            
            // 更新得分
            if (isCorrect) {
                score++;
                scoreElement.textContent = score;
            }
            
            // 记录答题结果
            answeredQuestions.push({
                question: question,
                userAnswer: userAnswer,
                isCorrect: isCorrect
            });
            
            // 显示正确答案和解析
            const feedbackContainer = document.createElement('div');
            feedbackContainer.className = 'mt-4 space-y-2';
            
            if (!isCorrect) {
                const correctAnswerElement = document.createElement('div');
                correctAnswerElement.className = 'p-2 bg-yellow-50 rounded text-sm';
                correctAnswerElement.innerHTML = `<strong>正确答案：</strong>${question.correctAnswer}`;
                feedbackContainer.appendChild(correctAnswerElement);
            }
            
            const explanation = document.createElement('div');
            explanation.className = 'p-3 bg-blue-50 rounded-lg text-sm';
            explanation.innerHTML = `<strong>解析：</strong>${question.explanation}`;
            feedbackContainer.appendChild(explanation);
            
            answerContainer.appendChild(feedbackContainer);
            
            // 显示下一题按钮
            nextBtn.classList.remove('hidden');
            
            // 显示反馈
            showFeedback(isCorrect ? '回答正确！' : '回答错误', isCorrect ? 'success' : 'error');
        }

        // 选择解剖图热点
        function selectHotspot(hotspotElement, hotspot) {
            // 移除之前选中的热点样式
            if (selectedHotspot) {
                selectedHotspot.classList.remove('active');
            }
            
            // 设置新选中的热点
            selectedHotspot = hotspotElement;
            selectedHotspot.classList.add('active');
        }

        // 检查解剖识别题答案
        function checkAnatomyIdentificationAnswer(question, selectedIndex, optionElement) {
            const isCorrect = selectedIndex === question.correctAnswer;
            
            // 禁用所有选项
            const options = answerContainer.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.removeEventListener('click', arguments.callee);
                option.style.pointerEvents = 'none';
            });
            
            // 禁用所有热点
            const hotspots = anatomyImage.querySelectorAll('.anatomy-area');
            hotspots.forEach(hotspot => {
                hotspot.style.pointerEvents = 'none';
            });
            
            // 标记正确和错误的选项
            optionElement.classList.add(isCorrect ? 'correct' : 'incorrect');
            
            if (!isCorrect) {
                options[question.correctAnswer].classList.add('correct');
            }
            
            // 标记正确的热点
            const correctHotspotId = question.hotspots.find(hotspot => hotspot.correct).id;
            const correctHotspot = document.getElementById(correctHotspotId);
            correctHotspot.classList.add('border-accent', 'border-2');
            
            // 如果选中的热点不是正确的，标记为错误
            if (selectedHotspot && selectedHotspot.id !== correctHotspotId) {
                selectedHotspot.classList.add('border-danger', 'border-2');
            }
            
            // 更新得分
            if (isCorrect) {
                score++;
                scoreElement.textContent = score;
            }
            
            // 记录答题结果
            answeredQuestions.push({
                question: question,
                userAnswer: selectedIndex,
                isCorrect: isCorrect
            });
            
            // 显示解析
            const explanation = document.createElement('div');
            explanation.className = 'mt-4 p-3 bg-blue-50 rounded-lg text-sm';
            explanation.innerHTML = `<strong>解析：</strong>${question.explanation}`;
            answerContainer.appendChild(explanation);
            
            // 显示下一题按钮
            nextBtn.classList.remove('hidden');
            
            // 显示反馈
            showFeedback(isCorrect ? '回答正确！' : '回答错误', isCorrect ? 'success' : 'error');
            
            // 重置选中的热点
            selectedHotspot = null;
        }

        // 显示反馈弹窗
        function showFeedback(message, type) {
            // 设置图标和标题
            if (type === 'success') {
                feedbackIcon.className = 'fa fa-check-circle text-success text-5xl mb-4';
                feedbackTitle.textContent = '回答正确！';
                feedbackTitle.className = 'text-xl font-bold text-success mb-2';
            } else if (type === 'error') {
                feedbackIcon.className = 'fa fa-times-circle text-danger text-5xl mb-4';
                feedbackTitle.textContent = '回答错误';
                feedbackTitle.className = 'text-xl font-bold text-danger mb-2';
            } else if (type === 'warning') {
                feedbackIcon.className = 'fa fa-exclamation-circle text-warning text-5xl mb-4';
                feedbackTitle.textContent = '提示';
                feedbackTitle.className = 'text-xl font-bold text-warning mb-2';
            }
            
            // 设置消息
            feedbackMessage.textContent = message;
            
            // 显示弹窗
            feedbackModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 关闭反馈弹窗
        function closeFeedbackModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                feedbackModal.classList.add('hidden');
            }, 300);
        }

        // 开始计时器
        function startTimer() {
            startTime = new Date();
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                const currentTime = new Date();
                const elapsedTime = Math.floor((currentTime - startTime) / 1000);
                const minutes = Math.floor(elapsedTime / 60).toString().padStart(2, '0');
                const seconds = (elapsedTime % 60).toString().padStart(2, '0');
                timerElement.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // 停止计时器
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // 显示结果
        function showResult() {
            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            
            finalScoreElement.textContent = score;
            finalTotalElement.textContent = questions.length;
            
            // 根据得分显示不同的消息
            if (score === questions.length) {
                resultMessageElement.textContent = '太棒了！你对脊神经解剖学知识掌握得非常全面！';
            } else if (score >= questions.length * 0.7) {
                resultMessageElement.textContent = '做得不错！你对脊神经解剖学有很好的理解。';
            } else if (score >= questions.length * 0.5) {
                resultMessageElement.textContent = '还不错，继续努力！';
            } else {
                resultMessageElement.textContent = '需要更多练习，建议重新学习脊神经解剖学知识。';
            }
            
            // 生成错题回顾
            reviewContainer.innerHTML = '';
            
            const wrongAnswers = answeredQuestions.filter(q => !q.isCorrect);
            
            if (wrongAnswers.length === 0) {
                const noMistakesElement = document.createElement('div');
                noMistakesElement.className = 'text-center py-4 text-gray-700';
                noMistakesElement.textContent = '恭喜！你没有答错任何题目！';
                reviewContainer.appendChild(noMistakesElement);
            } else {
                wrongAnswers.forEach((item, index) => {
                    const question = item.question;
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'p-4 border border-gray-200 rounded-lg';
                    
                    let userAnswerText = '';
                    if (question.type === 'multiple-choice' || question.type === 'anatomy-identification') {
                        userAnswerText = question.options[item.userAnswer];
                    } else if (question.type === 'fill-blank') {
                        userAnswerText = item.userAnswer;
                    }
                    
                    let correctAnswerText = '';
                    if (question.type === 'multiple-choice' || question.type === 'anatomy-identification') {
                        correctAnswerText = question.options[question.correctAnswer];
                    } else if (question.type === 'fill-blank') {
                        correctAnswerText = question.correctAnswer;
                    }
                    
                    reviewItem.innerHTML = `
                        <div class="flex items-start">
                            <div class="bg-danger text-white rounded-full w-6 h-6 flex items-center justify-center mt-1 mr-3 flex-shrink-0">${index + 1}</div>
                            <div>
                                <p class="font-semibold mb-2">${question.question}</p>
                                <p class="text-sm text-gray-600 mb-1"><span class="font-medium">你的答案：</span>${userAnswerText}</p>
                                <p class="text-sm text-success mb-2"><span class="font-medium">正确答案：</span>${correctAnswerText}</p>
                                <p class="text-sm bg-blue-50 p-2 rounded"><span class="font-medium">解析：</span>${question.explanation}</p>
                            </div>
                        </div>
                    `;
                    
                    reviewContainer.appendChild(reviewItem);
                });
            }
        }

        // 重置缩放
        function resetZoom() {
            zoomLevel = 1;
            const img = anatomyImage.querySelector('img');
            if (img) {
                img.style.transform = `scale(${zoomLevel})`;
            }
        }

        // 事件监听器
        startBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            initGame();
        });

        restartBtn.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            initGame();
        });

        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            progressText.textContent = `${currentQuestionIndex + 1}/${questions.length}`;
            progressBar.style.width = `${(currentQuestionIndex + 1) / questions.length * 100}%`;
            
            if (currentQuestionIndex < questions.length) {
                resetZoom();
                loadQuestion(currentQuestionIndex);
            } else {
                stopTimer();
                showResult();
            }
        });

        zoomInBtn.addEventListener('click', () => {
            zoomLevel += 0.1;
            if (zoomLevel > 2) zoomLevel = 2;
            const img = anatomyImage.querySelector('img');
            if (img) {
                img.style.transform = `scale(${zoomLevel})`;
            }
        });

        zoomOutBtn.addEventListener('click', () => {
            zoomLevel -= 0.1;
            if (zoomLevel < 0.5) zoomLevel = 0.5;
            const img = anatomyImage.querySelector('img');
            if (img) {
                img.style.transform = `scale(${zoomLevel})`;
            }
        });

        zoomResetBtn.addEventListener('click', resetZoom);

        feedbackClose.addEventListener('click', closeFeedbackModal);
        modalOverlay.addEventListener('click', closeFeedbackModal);
    </script>
</body>
</html>
