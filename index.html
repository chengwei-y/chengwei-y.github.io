<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心脏形态学测验</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#E53E3E',
                        accent: '#38B2AC',
                        neutral: '#1F2937',
                        light: '#F9FAFB'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.02);
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-light to-blue-50 min-h-screen text-neutral">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-md sticky top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-heartbeat text-secondary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">心脏形态学测验</h1>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <span class="text-sm text-gray-600"><i class="fa fa-user-o mr-1"></i> 解剖学课程</span>
                <button id="helpBtn" class="text-gray-600 hover:text-primary transition-custom">
                    <i class="fa fa-question-circle mr-1"></i> 帮助
                </button>
            </div>
            <button id="mobileMenuBtn" class="md:hidden text-gray-600">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div id="mobileMenu" class="hidden md:hidden bg-white border-t">
            <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
                <span class="text-sm text-gray-600 py-2"><i class="fa fa-user-o mr-1"></i> 解剖学课程</span>
                <button id="mobileHelpBtn" class="text-gray-600 hover:text-primary transition-custom py-2 text-left">
                    <i class="fa fa-question-circle mr-1"></i> 帮助
                </button>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8 md:py-12">
        <!-- 欢迎界面 -->
        <section id="welcomeSection" class="max-w-3xl mx-auto text-center">
            <div class="relative mb-8 rounded-xl overflow-hidden">
                <img src="https://picsum.photos/id/237/800/400" alt="心脏解剖图" class="w-full h-64 md:h-80 object-cover rounded-xl shadow-lg">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end">
                    <p class="text-white p-6 text-lg md:text-xl">测试您对心脏形态结构的掌握程度</p>
                </div>
            </div>
            
            <h2 class="text-2xl md:text-3xl font-bold mb-4 text-neutral">心脏形态学知识测验</h2>
            <p class="text-gray-600 mb-8">本测验包含10道关于心脏形态结构的题目，完成后将显示您的得分和正确答案解析。</p>
            
            <div class="flex flex-col md:flex-row justify-center gap-4 mb-8">
                <div class="flex items-center bg-white p-4 rounded-lg shadow-md">
                    <i class="fa fa-clock-o text-primary mr-3 text-xl"></i>
                    <div>
                        <p class="text-sm text-gray-500">预计完成时间</p>
                        <p class="font-medium">15分钟</p>
                    </div>
                </div>
                <div class="flex items-center bg-white p-4 rounded-lg shadow-md">
                    <i class="fa fa-question-circle text-primary mr-3 text-xl"></i>
                    <div>
                        <p class="text-sm text-gray-500">题目数量</p>
                        <p class="font-medium">10题</p>
                    </div>
                </div>
                <div class="flex items-center bg-white p-4 rounded-lg shadow-md">
                    <i class="fa fa-star text-primary mr-3 text-xl"></i>
                    <div>
                        <p class="text-sm text-gray-500">满分</p>
                        <p class="font-medium">100分</p>
                    </div>
                </div>
            </div>
            
            <button id="startQuizBtn" class="bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-custom transform hover:-translate-y-1">
                开始测验 <i class="fa fa-arrow-right ml-2"></i>
            </button>
        </section>

        <!-- 测验界面 -->
        <section id="quizSection" class="max-w-3xl mx-auto hidden">
            <!-- 进度条 -->
            <div class="mb-8">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">进度</span>
                    <span id="progressText" class="text-sm font-medium text-primary">1/10</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-primary rounded-full transition-all duration-500" style="width: 10%"></div>
                </div>
            </div>
            
            <!-- 题目卡片 -->
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 transform transition-all duration-500">
                <div class="flex items-center mb-4">
                    <span id="questionNumber" class="bg-primary/10 text-primary font-semibold px-3 py-1 rounded-full text-sm">问题 1</span>
                    <span id="questionPoints" class="ml-auto text-sm text-gray-500">10分</span>
                </div>
                
                <h3 id="questionText" class="text-xl md:text-2xl font-semibold mb-6">心脏的正常位置是在胸腔的哪个区域？</h3>
                
                <!-- 选择题选项 -->
                <div id="choicesContainer" class="space-y-3 mb-6">
                    <div class="choice-option border border-gray-200 hover:border-primary rounded-lg p-4 cursor-pointer transition-custom hover:bg-primary/5">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="question1" value="A" class="w-4 h-4 text-primary">
                            <span class="ml-3">A. 胸腔左侧，完全位于左肺内</span>
                        </label>
                    </div>
                    <div class="choice-option border border-gray-200 hover:border-primary rounded-lg p-4 cursor-pointer transition-custom hover:bg-primary/5">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="question1" value="B" class="w-4 h-4 text-primary">
                            <span class="ml-3">B. 胸腔中部偏左，约2/3位于中线左侧</span>
                        </label>
                    </div>
                    <div class="choice-option border border-gray-200 hover:border-primary rounded-lg p-4 cursor-pointer transition-custom hover:bg-primary/5">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="question1" value="C" class="w-4 h-4 text-primary">
                            <span class="ml-3">C. 胸腔正中央，左右对称分布</span>
                        </label>
                    </div>
                    <div class="choice-option border border-gray-200 hover:border-primary rounded-lg p-4 cursor-pointer transition-custom hover:bg-primary/5">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="question1" value="D" class="w-4 h-4 text-primary">
                            <span class="ml-3">D. 胸腔右侧，靠近右肺门</span>
                        </label>
                    </div>
                </div>
                
                <!-- 填空题输入框 (默认隐藏) -->
                <div id="fillBlankContainer" class="hidden mb-6">
                    <input type="text" id="blankAnswer" class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-primary focus:border-primary transition-custom" placeholder="请输入答案...">
                </div>
                
                <!-- 答案反馈 (默认隐藏) -->
                <div id="feedbackContainer" class="hidden p-4 rounded-lg mb-6">
                    <div class="flex items-start">
                        <i id="feedbackIcon" class="fa fa-check-circle text-green-500 text-xl mt-1 mr-3"></i>
                        <div>
                            <p id="feedbackText" class="font-medium"></p>
                            <p id="explanationText" class="text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 导航按钮 -->
            <div class="flex justify-between">
                <button id="prevBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-6 rounded-lg transition-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fa fa-arrow-left mr-2"></i> 上一题
                </button>
                <button id="nextBtn" class="bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition-custom">
                    下一题 <i class="fa fa-arrow-right ml-2"></i>
                </button>
                <button id="submitBtn" class="hidden bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-6 rounded-lg transition-custom">
                    提交答案 <i class="fa fa-check ml-2"></i>
                </button>
            </div>
        </section>

        <!-- 结果界面 -->
        <section id="resultsSection" class="max-w-3xl mx-auto hidden">
            <div class="text-center mb-8">
                <h2 class="text-2xl md:text-3xl font-bold mb-2">测验完成！</h2>
                <p class="text-gray-600">以下是您的测验结果</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
                <div class="flex flex-col md:flex-row items-center justify-between mb-8">
                    <div class="mb-6 md:mb-0">
                        <p class="text-gray-500 mb-1">您的得分</p>
                        <div class="flex items-end">
                            <span id="finalScore" class="text-4xl md:text-5xl font-bold text-primary">80</span>
                            <span class="text-gray-500 ml-2 mb-1">/ 100</span>
                        </div>
                    </div>
                    
                    <div class="w-full md:w-1/2">
                        <canvas id="resultsChart" width="300" height="200"></canvas>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                        <p class="text-green-600 font-bold text-2xl" id="correctAnswers">8</p>
                        <p class="text-sm text-gray-600">正确</p>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 text-center">
                        <p class="text-red-600 font-bold text-2xl" id="incorrectAnswers">2</p>
                        <p class="text-sm text-gray-600">错误</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <p class="text-blue-600 font-bold text-2xl">10</p>
                        <p class="text-sm text-gray-600">总题数</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4 text-center">
                        <p class="text-purple-600 font-bold text-2xl" id="accuracy">80%</p>
                        <p class="text-sm text-gray-600">正确率</p>
                    </div>
                </div>
                
                <button id="reviewBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 rounded-lg transition-custom mb-4">
                    <i class="fa fa-list-alt mr-2"></i> 查看答题详情
                </button>
                <button id="restartBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 rounded-lg transition-custom">
                    <i class="fa fa-refresh mr-2"></i> 重新测验
                </button>
            </div>
            
            <!-- 答题详情 (默认隐藏) -->
            <div id="detailedResults" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">答题详情</h3>
                    <button id="closeDetailsBtn" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div id="questionsList" class="space-y-6">
                    <!-- 答题详情将通过JS动态生成 -->
                </div>
            </div>
        </section>
    </main>

    <!-- 帮助模态框 (默认隐藏) -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-primary">测验帮助</h3>
                <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-gray-700">
                <p><i class="fa fa-info-circle text-primary mr-2"></i> 本测验包含10道关于心脏形态结构的题目</p>
                <p><i class="fa fa-check-circle text-green-500 mr-2"></i> 选择答案后点击"下一题"或"提交答案"进行提交</p>
                <p><i class="fa fa-arrow-left text-gray-500 mr-2"></i> 可以通过"上一题"按钮返回修改答案</p>
                <p><i class="fa fa-bar-chart text-blue-500 mr-2"></i> 完成所有题目后将显示您的得分和详细解析</p>
                <p><i class="fa fa-refresh text-purple-500 mr-2"></i> 完成测验后可以选择重新测试</p>
            </div>
            
            <button id="gotItBtn" class="mt-6 w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 rounded-lg transition-custom">
                明白了
            </button>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm text-gray-500">© 2023 解剖学教学资源 | 心脏形态学测验</p>
                </div>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-500 hover:text-primary transition-custom"><i class="fa fa-book"></i> 学习资料</a>
                    <a href="#" class="text-gray-500 hover:text-primary transition-custom"><i class="fa fa-graduation-cap"></i> 课程主页</a>
                    <a href="#" class="text-gray-500 hover:text-primary transition-custom"><i class="fa fa-envelope-o"></i> 联系我们</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // 题目数据
        const questions = [
            {
                id: 1,
                type: 'multiple',
                text: '心脏的正常位置是在胸腔的哪个区域？',
                choices: [
                    'A. 胸腔左侧，完全位于左肺内',
                    'B. 胸腔中部偏左，约2/3位于中线左侧',
                    'C. 胸腔正中央，左右对称分布',
                    'D. 胸腔右侧，靠近右肺门'
                ],
                correctAnswer: 'B',
                explanation: '心脏位于胸腔中纵隔内，约2/3位于身体中线左侧，1/3位于中线右侧，前方对向胸骨体和第2-6肋软骨，后方平对第5-8胸椎。'
            },
            {
                id: 2,
                type: 'multiple',
                text: '心脏的外形可分为几个面？',
                choices: [
                    'A. 1个面',
                    'B. 2个面',
                    'C. 3个面',
                    'D. 4个面'
                ],
                correctAnswer: 'C',
                explanation: '心脏的外形可分为胸肋面（前面）、膈面（下面）和肺面（后面）三个面。'
            },
            {
                id: 3,
                type: 'fill',
                text: '心脏心底朝向______方，心尖指向______方。',
                correctAnswer: '右上,左下',
                explanation: '心脏心底朝向右上方，与出入心的大血管相连；心尖朝向左下方，平对左侧第5肋间隙，锁骨中线内侧1-2cm处。'
            },
            {
                id: 4,
                type: 'multiple',
                text: '下列哪项不是心脏的四个腔室之一？',
                choices: [
                    'A. 左心房',
                    'B. 右心室',
                    'C. 左心耳',
                    'D. 右心房'
                ],
                correctAnswer: 'C',
                explanation: '心脏分为四个腔室：左心房、左心室、右心房和右心室。左心耳是左心房向前突出的部分，不属于独立腔室。'
            },
            {
                id: 5,
                type: 'multiple',
                text: '心尖的构成主要是？',
                choices: [
                    'A. 左心房',
                    'B. 右心室',
                    'C. 左心室',
                    'D. 右心房'
                ],
                correctAnswer: 'C',
                explanation: '心尖主要由左心室构成，是心脏最下端的部分，可在体表触及心尖搏动。'
            },
            {
                id: 6,
                type: 'fill',
                text: '房间隔位于左右心房之间，其下部有一浅凹称为______，是胚胎时期卵圆孔闭合后的遗迹。',
                correctAnswer: '卵圆窝',
                explanation: '卵圆窝是房间隔右侧面中下部的一卵圆形浅凹，是胚胎时期卵圆孔闭合后的遗迹，此处房壁最薄，是房间隔缺损的好发部位。'
            },
            {
                id: 7,
                type: 'multiple',
                text: '心室壁中最厚的是？',
                choices: [
                    'A. 右心房壁',
                    'B. 右心室壁',
                    'C. 左心房壁',
                    'D. 左心室壁'
                ],
                correctAnswer: 'D',
                explanation: '左心室壁最厚，这是因为左心室需要将血液泵至全身，承受的压力最大，约为右心室壁厚度的3倍。'
            },
            {
                id: 8,
                type: 'multiple',
                text: '心表面分隔心房和心室的沟是？',
                choices: [
                    'A. 前室间沟',
                    'B. 后室间沟',
                    'C. 冠状沟',
                    'D. 房间沟'
                ],
                correctAnswer: 'C',
                explanation: '冠状沟是心表面的环形沟，近似冠状位，分隔上方的心房和下方的心室。前室间沟和后室间沟是分隔左右心室的标志。'
            },
            {
                id: 9,
                type: 'fill',
                text: '右心室流出道又称______，向上通向肺动脉干。',
                correctAnswer: '动脉圆锥',
                explanation: '动脉圆锥是右心室流出道的上部，内壁光滑无肉柱，向上通向肺动脉干，是右心室与肺动脉之间的通道。'
            },
            {
                id: 10,
                type: 'multiple',
                text: '下列关于心脏形态的描述，错误的是？',
                choices: [
                    'A. 心脏大小约与本人拳头相当',
                    'B. 心尖由左心室构成',
                    'C. 心底大部分由左心房构成',
                    'D. 心脏呈典型的圆锥形'
                ],
                correctAnswer: 'D',
                explanation: '心脏的外形近似倒置的、前后稍扁的圆锥体，而非典型的圆锥形。其大小约与本人拳头相当，心尖由左心室构成，心底大部分由左心房构成，小部分由右心房构成。'
            }
        ];

        // 全局变量
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;

        // DOM 元素
        const welcomeSection = document.getElementById('welcomeSection');
        const quizSection = document.getElementById('quizSection');
        const resultsSection = document.getElementById('resultsSection');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const questionNumber = document.getElementById('questionNumber');
        const questionText = document.getElementById('questionText');
        const choicesContainer = document.getElementById('choicesContainer');
        const fillBlankContainer = document.getElementById('fillBlankContainer');
        const blankAnswer = document.getElementById('blankAnswer');
        const feedbackContainer = document.getElementById('feedbackContainer');
        const feedbackIcon = document.getElementById('feedbackIcon');
        const feedbackText = document.getElementById('feedbackText');
        const explanationText = document.getElementById('explanationText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const finalScore = document.getElementById('finalScore');
        const correctAnswers = document.getElementById('correctAnswers');
        const incorrectAnswers = document.getElementById('incorrectAnswers');
        const accuracy = document.getElementById('accuracy');
        const restartBtn = document.getElementById('restartBtn');
        const reviewBtn = document.getElementById('reviewBtn');
        const detailedResults = document.getElementById('detailedResults');
        const questionsList = document.getElementById('questionsList');
        const closeDetailsBtn = document.getElementById('closeDetailsBtn');
        const helpBtn = document.getElementById('helpBtn');
        const mobileHelpBtn = document.getElementById('mobileHelpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const gotItBtn = document.getElementById('gotItBtn');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');

        // 初始化事件监听
        function initEventListeners() {
            startQuizBtn.addEventListener('click', startQuiz);
            prevBtn.addEventListener('click', goToPreviousQuestion);
            nextBtn.addEventListener('click', goToNextQuestion);
            submitBtn.addEventListener('click', submitAnswer);
            restartBtn.addEventListener('click', restartQuiz);
            reviewBtn.addEventListener('click', showDetailedResults);
            closeDetailsBtn.addEventListener('click', hideDetailedResults);
            helpBtn.addEventListener('click', showHelpModal);
            mobileHelpBtn.addEventListener('click', showHelpModal);
            closeHelpBtn.addEventListener('click', hideHelpModal);
            gotItBtn.addEventListener('click', hideHelpModal);
            mobileMenuBtn.addEventListener('click', toggleMobileMenu);
        }

        // 切换移动菜单
        function toggleMobileMenu() {
            mobileMenu.classList.toggle('hidden');
        }

        // 显示帮助模态框
        function showHelpModal() {
            helpModal.classList.remove('hidden');
            helpModal.classList.add('flex');
        }

        // 隐藏帮助模态框
        function hideHelpModal() {
            helpModal.classList.add('hidden');
            helpModal.classList.remove('flex');
        }

        // 开始测验
        function startQuiz() {
            welcomeSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            currentQuestionIndex = 0;
            userAnswers = new Array(questions.length).fill(null);
            score = 0;
            loadQuestion(currentQuestionIndex);
            window.scrollTo(0, 0);
        }

        // 加载题目
        function loadQuestion(index) {
            const question = questions[index];
            
            // 更新题目信息
            questionNumber.textContent = `问题 ${question.id}`;
            questionText.textContent = question.text;
            progressText.textContent = `${index + 1}/${questions.length}`;
            progressBar.style.width = `${((index + 1) / questions.length) * 100}%`;
            
            // 重置反馈
            feedbackContainer.classList.add('hidden');
            
            // 根据题型显示不同的答题区域
            if (question.type === 'multiple') {
                choicesContainer.classList.remove('hidden');
                fillBlankContainer.classList.add('hidden');
                
                // 清空并重新生成选项
                choicesContainer.innerHTML = '';
                question.choices.forEach((choice, i) => {
                    const choiceDiv = document.createElement('div');
                    choiceDiv.className = 'choice-option border border-gray-200 hover:border-primary rounded-lg p-4 cursor-pointer transition-custom hover:bg-primary/5';
                    
                    const label = document.createElement('label');
                    label.className = 'flex items-center cursor-pointer';
                    
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question${question.id}`;
                    input.value = String.fromCharCode(65 + i); // A, B, C, D...
                    input.className = 'w-4 h-4 text-primary';
                    
                    // 如果有保存的答案，选中它
                    if (userAnswers[index] === input.value) {
                        input.checked = true;
                    }
                    
                    const span = document.createElement('span');
                    span.className = 'ml-3';
                    span.textContent = choice;
                    
                    label.appendChild(input);
                    label.appendChild(span);
                    choiceDiv.appendChild(label);
                    choicesContainer.appendChild(choiceDiv);
                });
            } else if (question.type === 'fill') {
                choicesContainer.classList.add('hidden');
                fillBlankContainer.classList.remove('hidden');
                
                // 填充保存的答案
                blankAnswer.value = userAnswers[index] || '';
            }
            
            // 更新按钮状态
            prevBtn.disabled = index === 0;
            
            if (index === questions.length - 1) {
                nextBtn.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.remove('hidden');
                submitBtn.classList.add('hidden');
            }
            
            // 如果已经回答过，显示反馈
            if (userAnswers[index] !== null) {
                showFeedback(index);
            }
        }

        // 获取当前答案
        function getCurrentAnswer() {
            const question = questions[currentQuestionIndex];
            
            if (question.type === 'multiple') {
                const selectedOption = document.querySelector(`input[name="question${question.id}"]:checked`);
                return selectedOption ? selectedOption.value : null;
            } else if (question.type === 'fill') {
                return blankAnswer.value.trim();
            }
            
            return null;
        }

        // 保存当前答案
        function saveCurrentAnswer() {
            const answer = getCurrentAnswer();
            userAnswers[currentQuestionIndex] = answer;
            return answer !== null;
        }

        // 显示反馈
        function showFeedback(index) {
            const question = questions[index];
            const userAnswer = userAnswers[index];
            let isCorrect = false;
            
            // 判断答案是否正确
            if (question.type === 'multiple') {
                isCorrect = userAnswer === question.correctAnswer;
            } else if (question.type === 'fill') {
                // 对填空题进行简单的容错处理（忽略空格和大小写）
                const normalizedUserAnswer = userAnswer.toLowerCase().replace(/\s+/g, '');
                const normalizedCorrectAnswer = question.correctAnswer.toLowerCase().replace(/\s+/g, '');
                isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
            }
            
            // 更新反馈内容
            if (isCorrect) {
                feedbackIcon.className = 'fa fa-check-circle text-green-500 text-xl mt-1 mr-3';
                feedbackText.className = 'font-medium text-green-600';
                feedbackText.textContent = '回答正确！';
            } else {
                feedbackIcon.className = 'fa fa-times-circle text-red-500 text-xl mt-1 mr-3';
                feedbackText.className = 'font-medium text-red-600';
                
                if (question.type === 'multiple') {
                    feedbackText.textContent = `回答错误。正确答案是：${question.correctAnswer}`;
                } else {
                    feedbackText.textContent = `回答错误。正确答案是：${question.correctAnswer}`;
                }
            }
            
            explanationText.textContent = question.explanation;
            feedbackContainer.classList.remove('hidden');
        }

        // 提交答案
        function submitAnswer() {
            if (!saveCurrentAnswer()) {
                alert('请先选择或输入答案');
                return;
            }
            
            showFeedback(currentQuestionIndex);
            
            // 如果是最后一题，计算分数并显示结果
            if (currentQuestionIndex === questions.length - 1) {
                calculateScore();
                setTimeout(showResults, 1500);
            }
        }

        // 前往上一题
        function goToPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                saveCurrentAnswer();
                currentQuestionIndex--;
                loadQuestion(currentQuestionIndex);
                window.scrollTo(0, 0);
            }
        }

        // 前往下一题
        function goToNextQuestion() {
            if (!saveCurrentAnswer()) {
                alert('请先选择或输入答案');
                return;
            }
            
            showFeedback(currentQuestionIndex);
            
            if (currentQuestionIndex < questions.length - 1) {
                setTimeout(() => {
                    currentQuestionIndex++;
                    loadQuestion(currentQuestionIndex);
                    window.scrollTo(0, 0);
                }, 800);
            }
        }

        // 计算分数
        function calculateScore() {
            score = 0;
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                
                if (question.type === 'multiple') {
                    isCorrect = userAnswer === question.correctAnswer;
                } else if (question.type === 'fill') {
                    const normalizedUserAnswer = userAnswer.toLowerCase().replace(/\s+/g, '');
                    const normalizedCorrectAnswer = question.correctAnswer.toLowerCase().replace(/\s+/g, '');
                    isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
                }
                
                if (isCorrect) {
                    score += 10; // 每题10分
                }
            });
        }

        // 显示结果
        function showResults() {
            quizSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            // 更新结果信息
            finalScore.textContent = score;
            
            const correctCount = score / 10;
            const incorrectCount = questions.length - correctCount;
            const accuracyPercent = Math.round((correctCount / questions.length) * 100);
            
            correctAnswers.textContent = correctCount;
            incorrectAnswers.textContent = incorrectCount;
            accuracy.textContent = `${accuracyPercent}%`;
            
            // 创建结果图表
            createResultsChart(correctCount, incorrectCount);
            
            window.scrollTo(0, 0);
        }

        // 创建结果图表
        function createResultsChart(correct, incorrect) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['正确', '错误'],
                    datasets: [{
                        data: [correct, incorrect],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // 显示详细结果
        function showDetailedResults() {
            resultsSection.querySelector('> div:not(#detailedResults)').classList.add('hidden');
            detailedResults.classList.remove('hidden');
            
            // 生成详细结果列表
            questionsList.innerHTML = '';
            
            questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                
                if (question.type === 'multiple') {
                    isCorrect = userAnswer === question.correctAnswer;
                } else if (question.type === 'fill') {
                    const normalizedUserAnswer = userAnswer.toLowerCase().replace(/\s+/g, '');
                    const normalizedCorrectAnswer = question.correctAnswer.toLowerCase().replace(/\s+/g, '');
                    isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
                }
                
                const questionDiv = document.createElement('div');
                questionDiv.className = `p-4 rounded-lg border ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`;
                
                const questionHeader = document.createElement('div');
                questionHeader.className = 'flex justify-between items-start mb-3';
                
                const questionNumber = document.createElement('span');
                questionNumber.className = `font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'}`;
                questionNumber.textContent = `问题 ${question.id}`;
                
                const statusIcon = document.createElement('i');
                statusIcon.className = `text-xl ${isCorrect ? 'fa fa-check-circle text-green-500' : 'fa fa-times-circle text-red-500'}`;
                
                questionHeader.appendChild(questionNumber);
                questionHeader.appendChild(statusIcon);
                
                const questionText = document.createElement('p');
                questionText.className = 'mb-3 text-gray-800';
                questionText.textContent = question.text;
                
                const userAnswerDiv = document.createElement('div');
                userAnswerDiv.className = 'mb-2';
                
                const userAnswerLabel = document.createElement('p');
                userAnswerLabel.className = 'text-sm font-medium text-gray-600 mb-1';
                userAnswerLabel.textContent = '你的答案：';
                
                const userAnswerValue = document.createElement('p');
                userAnswerValue.className = 'text-sm';
                userAnswerValue.textContent = userAnswer || '未回答';
                
                userAnswerDiv.appendChild(userAnswerLabel);
                userAnswerDiv.appendChild(userAnswerValue);
                
                const correctAnswerDiv = document.createElement('div');
                correctAnswerDiv.className = 'mb-2';
                
                const correctAnswerLabel = document.createElement('p');
                correctAnswerLabel.className = 'text-sm font-medium text-gray-600 mb-1';
                correctAnswerLabel.textContent = '正确答案：';
                
                const correctAnswerValue = document.createElement('p');
                correctAnswerValue.className = 'text-sm font-medium text-primary';
                correctAnswerValue.textContent = question.correctAnswer;
                
                correctAnswerDiv.appendChild(correctAnswerLabel);
                correctAnswerDiv.appendChild(correctAnswerValue);
                
                const explanationDiv = document.createElement('div');
                
                const explanationLabel = document.createElement('p');
                explanationLabel.className = 'text-sm font-medium text-gray-600 mb-1';
                explanationLabel.textContent = '解析：';
                
                const explanationText = document.createElement('p');
                explanationText.className = 'text-sm text-gray-600';
                explanationText.textContent = question.explanation;
                
                explanationDiv.appendChild(explanationLabel);
                explanationDiv.appendChild(explanationText);
                
                questionDiv.appendChild(questionHeader);
                questionDiv.appendChild(questionText);
                questionDiv.appendChild(userAnswerDiv);
                questionDiv.appendChild(correctAnswerDiv);
                questionDiv.appendChild(explanationDiv);
                
                questionsList.appendChild(questionDiv);
            });
        }

        // 隐藏详细结果
        function hideDetailedResults() {
            detailedResults.classList.add('hidden');
            resultsSection.querySelector('> div:not(#detailedResults)').classList.remove('hidden');
        }

        // 重新测验
        function restartQuiz() {
            resultsSection.classList.add('hidden');
            startQuiz();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
        });
    </script>
</body>
</html>
