<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>近视远视模拟器（凸透镜形状优化版）</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        accent: '#0ea5e9',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #f8fafc;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
        }
        
        #eyeCanvas {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .control-btn {
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="container mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">近视远视模拟器</h1>
            <p class="text-gray-600">凸透镜优化为中间厚、上下薄的半椭圆形</p>
        </header>
        
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- 左侧演示区 -->
            <div class="lg:w-2/3 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">眼球结构演示</h2>
                <div class="canvas-container">
                    <canvas id="eyeCanvas"></canvas>
                    <div class="info-panel" id="eyeInfo">
                        <span class="font-medium">眼睛类型：</span>
                        <span id="currentEyeType">正常眼</span>
                    </div>
                    <div class="info-panel" style="top: 40px;" id="lensInfo">
                        <span class="font-medium">矫正透镜：</span>
                        <span id="currentLensType">无透镜</span>
                    </div>
                </div>
            </div>
            
            <!-- 右侧设置区 -->
            <div class="lg:w-1/3 bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">交互设置</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">眼睛类型</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button id="normalEye" class="control-btn active bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-3 px-4 rounded-lg flex flex-col items-center justify-center">
                            <i class="fa fa-eye mr-2"></i>
                            <span>正常眼</span>
                        </button>
                        <button id="myopiaEye" class="control-btn bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium py-3 px-4 rounded-lg flex flex-col items-center justify-center">
                            <i class="fa fa-search-minus mr-2"></i>
                            <span>近视眼</span>
                        </button>
                        <button id="hyperopiaEye" class="control-btn bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium py-3 px-4 rounded-lg flex flex-col items-center justify-center">
                            <i class="fa fa-search-plus mr-2"></i>
                            <span>远视眼</span>
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">矫正透镜</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <button id="noLens" class="control-btn active bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-3 px-4 rounded-lg flex flex-col items-center justify-center">
                            <i class="fa fa-minus mr-2"></i>
                            <span>无透镜</span>
                        </button>
                        <button id="concaveLens" class="control-btn bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium py-3 px-4 rounded-lg flex flex-col items-center justify-center">
                            <i class="fa fa-compress mr-2"></i>
                            <span>凹透镜</span>
                        </button>
                        <button id="convexLens" class="control-btn bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium py-3 px-4 rounded-lg flex flex-col items-center justify-center">
                            <i class="fa fa-expand mr-2"></i>
                            <span>凸透镜</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-blue-700 mb-2">原理说明</h3>
                    <div id="description" class="text-sm text-blue-600">
                        <p><strong>凸透镜特性：</strong>中间厚、上下薄的半椭圆形，能汇聚光线。</p>
                        <p><strong>错误矫正：</strong>远视眼用凹透镜/近视眼用凸透镜会加剧焦点偏移。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化Canvas
        const canvas = document.getElementById('eyeCanvas');
        const ctx = canvas.getContext('2d');
        
        // 设置Canvas尺寸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth * 0.95;
            canvas.height = 400;
            drawEye();
        }
        
        // 初始化时调整尺寸并监听窗口大小变化
        window.addEventListener('load', () => {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        });
        
        // 眼睛参数 - 基础焦点偏移
        const eyeParams = {
            normal: { 
                lensWidth: 50, 
                lensHeight: 90,
                focusOffset: 0, // 焦点在视网膜上
                description: '<p><strong>正常眼：</strong>晶状体形状适中，光线聚焦在视网膜上。</p>'
            },
            myopia: { 
                lensWidth: 70, 
                lensHeight: 90,
                focusOffset: -30, // 焦点在视网膜左侧（基础偏移）
                description: '<p><strong>近视眼：</strong>晶状体过宽，光线聚焦在视网膜前方。</p><p>需用凹透镜矫正。</p>'
            },
            hyperopia: { 
                lensWidth: 30, 
                lensHeight: 90,
                focusOffset: 30, // 焦点在视网膜右侧（基础偏移）
                description: '<p><strong>远视眼：</strong>晶状体过窄，光线聚焦在视网膜后方。</p><p>需用凸透镜矫正。</p>'
            }
        };
        
        // 透镜参数 - 调整焦点偏移的效果值
        const lensParams = {
            none: {
                effect: 0,
                description: '<p><strong>无透镜：</strong>不使用任何矫正透镜。</p>'
            },
            concave: {
                effect: 40, // 发散光线（使焦点右移）
                description: '<p><strong>凹透镜：</strong>中间薄、边缘厚，能发散光线，用于矫正近视眼。</p><p>错误用于远视眼时，会使焦点更靠后。</p>'
            },
            convex: {
                effect: -40, // 汇聚光线（使焦点左移）
                description: '<p><strong>凸透镜：</strong>中间厚、上下薄的半椭圆形，能汇聚光线，用于矫正远视眼。</p><p>错误用于近视眼时，会使焦点更靠前。</p>'
            }
        };
        
        // 当前状态
        let currentEye = 'normal';
        let currentLens = 'none';
        
        // DOM元素
        const normalEyeBtn = document.getElementById('normalEye');
        const myopiaEyeBtn = document.getElementById('myopiaEye');
        const hyperopiaEyeBtn = document.getElementById('hyperopiaEye');
        const noLensBtn = document.getElementById('noLens');
        const concaveLensBtn = document.getElementById('concaveLens');
        const convexLensBtn = document.getElementById('convexLens');
        const currentEyeTypeEl = document.getElementById('currentEyeType');
        const currentLensTypeEl = document.getElementById('currentLensType');
        const descriptionEl = document.getElementById('description');
        
        // 更新按钮状态和描述
        function updateButtons() {
            // 重置按钮状态
            normalEyeBtn.classList.remove('active');
            myopiaEyeBtn.classList.remove('active');
            hyperopiaEyeBtn.classList.remove('active');
            noLensBtn.classList.remove('active');
            concaveLensBtn.classList.remove('active');
            convexLensBtn.classList.remove('active');
            
            // 激活当前选择
            switch(currentEye) {
                case 'normal': normalEyeBtn.classList.add('active'); break;
                case 'myopia': myopiaEyeBtn.classList.add('active'); break;
                case 'hyperopia': hyperopiaEyeBtn.classList.add('active'); break;
            }
            switch(currentLens) {
                case 'none': noLensBtn.classList.add('active'); break;
                case 'concave': concaveLensBtn.classList.add('active'); break;
                case 'convex': convexLensBtn.classList.add('active'); break;
            }
            
            // 更新文本显示
            currentEyeTypeEl.textContent = currentEye === 'normal' ? '正常眼' : 
                                          currentEye === 'myopia' ? '近视眼' : '远视眼';
            currentLensTypeEl.textContent = currentLens === 'none' ? '无透镜' : 
                                          currentLens === 'concave' ? '凹透镜' : '凸透镜';
            
            // 更新描述（强调凸透镜形状特性）
            descriptionEl.innerHTML = '<p><strong>凸透镜特性：</strong>中间厚、上下薄的半椭圆形，能汇聚光线。</p>' +
                                     eyeParams[currentEye].description + lensParams[currentLens].description;
        }
        
        // 计算最终焦点位置
        function getFinalFocusPoint() {
            const retinaX = canvas.width / 2 + 150 - 10; // 视网膜X坐标（固定）
            const centerY = canvas.height / 2; // 中心Y坐标
            
            // 获取基础偏移量（眼睛本身的焦点偏移）
            let offsetX = eyeParams[currentEye].focusOffset;
            
            // 应用透镜效果
            offsetX += lensParams[currentLens].effect;
            
            // 仅在正确矫正组合时强制焦点在视网膜上
            if ((currentEye === 'myopia' && currentLens === 'concave') || 
                (currentEye === 'hyperopia' && currentLens === 'convex')) {
                offsetX = 0; // 正确矫正：焦点在视网膜
            }
            
            return {
                x: retinaX + offsetX,
                y: centerY
            };
        }
        
        // 绘制矫正透镜（核心优化：凸透镜改为中间厚、上下薄的半椭圆形）
        function drawCorrectionLens(centerX, centerY) {
            if (currentLens === 'none') return;
            
            const lensX = centerX - 200;
            const lensWidth = 60;    // 水平宽度（中间厚的基础）
            const lensHeight = 100;  // 垂直高度（上下薄，比之前略窄）
            
            ctx.save();
            
            // 绘制透镜轮廓
            ctx.beginPath();
            if (currentLens === 'concave') {
                // 凹透镜：中间薄两边厚（保持原有形状）
                ctx.moveTo(lensX - lensWidth/2, centerY - lensHeight/2);
                ctx.quadraticCurveTo(lensX + lensWidth/3, centerY, lensX - lensWidth/2, centerY + lensHeight/2);
                ctx.lineTo(lensX + lensWidth/2, centerY + lensHeight/2);
                ctx.quadraticCurveTo(lensX - lensWidth/3, centerY, lensX + lensWidth/2, centerY - lensHeight/2);
            } else {
                // 凸透镜：优化为中间厚、上下薄的半椭圆形
                // 使用更平缓的曲线模拟椭圆弧，中间宽、上下窄
                const curveFactor = 0.7; // 控制曲线弧度，值越小中间越厚
                ctx.moveTo(lensX - lensWidth/2, centerY - lensHeight/2);
                // 左半部分曲线（上到下）：中间向外凸
                ctx.quadraticCurveTo(
                    lensX - lensWidth * curveFactor,  // 控制点X（向左突出，中间厚）
                    centerY,                          // 控制点Y（中心）
                    lensX - lensWidth/2, centerY + lensHeight/2
                );
                // 右半部分曲线（下到上）：对称设计
                ctx.lineTo(lensX + lensWidth/2, centerY + lensHeight/2);
                ctx.quadraticCurveTo(
                    lensX + lensWidth * curveFactor,  // 控制点X（向右突出，中间厚）
                    centerY,                          // 控制点Y（中心）
                    lensX + lensWidth/2, centerY - lensHeight/2
                );
            }
            ctx.closePath();
            
            // 填充透镜（渐变增强立体感）
            const gradient = ctx.createLinearGradient(lensX - lensWidth/2, centerY, lensX + lensWidth/2, centerY);
            if (currentLens === 'convex') {
                // 凸透镜中间更亮，增强"中间厚"的视觉效果
                gradient.addColorStop(0, 'rgba(173, 216, 230, 0.4)');
                gradient.addColorStop(0.5, 'rgba(173, 216, 230, 0.9)');
                gradient.addColorStop(1, 'rgba(173, 216, 230, 0.4)');
            } else {
                // 凹透镜渐变（保持原有）
                gradient.addColorStop(0, 'rgba(173, 216, 230, 0.5)');
                gradient.addColorStop(0.5, 'rgba(173, 216, 230, 0.8)');
                gradient.addColorStop(1, 'rgba(173, 216, 230, 0.5)');
            }
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // 透镜边框（增强形状辨识度）
            ctx.strokeStyle = 'rgba(70, 130, 180, 0.8)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.restore();
        }
        
        // 绘制眼球
        function drawEye() {
            if (!ctx) return;
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const eyeSize = 150; // 眼球大小
            
            // 绘制矫正透镜
            drawCorrectionLens(centerX, centerY);
            
            // 绘制眼球轮廓
            ctx.beginPath();
            ctx.arc(centerX, centerY, eyeSize, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 8;
            ctx.stroke();
            
            // 绘制视网膜（眼球后壁）
            ctx.beginPath();
            ctx.arc(centerX, centerY, eyeSize - 10, 0, Math.PI * 2);
            ctx.fillStyle = '#f0f0f0';
            ctx.fill();
            
            // 标记视网膜位置
            ctx.beginPath();
            ctx.moveTo(centerX + eyeSize - 10, centerY - 10);
            ctx.lineTo(centerX + eyeSize + 10, centerY - 10);
            ctx.strokeStyle = '#64748b';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('视网膜', centerX + eyeSize + 12, centerY - 8);
            
            // 绘制角膜
            ctx.beginPath();
            ctx.arc(centerX - eyeSize + 30, centerY, 40, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(173, 216, 230, 0.6)';
            ctx.fill();
            ctx.strokeStyle = 'rgba(70, 130, 180, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制瞳孔
            ctx.beginPath();
            ctx.arc(centerX - eyeSize + 40, centerY, 15, 0, Math.PI * 2);
            ctx.fillStyle = 'black';
            ctx.fill();
            
            // 绘制晶状体
            const lensParams = eyeParams[currentEye];
            ctx.beginPath();
            ctx.ellipse(
                centerX - 80, // 晶状体X位置
                centerY,      // 晶状体Y位置
                lensParams.lensWidth / 2,  // 宽度
                lensParams.lensHeight / 2, // 高度
                0, 0, Math.PI * 2
            );
            ctx.fillStyle = 'rgba(173, 216, 230, 0.7)';
            ctx.fill();
            ctx.strokeStyle = 'rgba(70, 130, 180, 0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 绘制光线
            drawLightRays(centerX, centerY, eyeSize);
        }
        
        // 绘制光线 - 确保所有光线仅在焦点处交汇
        function drawLightRays(centerX, centerY, eyeSize) {
            const rayCount = 5;          // 光线数量
            const raySpacing = 25;       // 光线间距
            const lensX = centerX - 80;  // 晶状体X位置
            const lensWidth = eyeParams[currentEye].lensWidth;
            const lensHalfWidth = lensWidth / 2;
            const lensHalfHeight = eyeParams[currentEye].lensHeight / 2;
            
            // 获取唯一焦点（所有光线在此交汇）
            const focus = getFinalFocusPoint();
            
            // 光线起点（左侧平行光线）
            const startX = centerX - 300;
            
            // 矫正透镜位置和宽度
            const correctionLensX = centerX - 200;
            const correctionLensWidth = 60;
            
            // 计算每条光线的路径
            for (let i = 0; i < rayCount; i++) {
                // 光线Y方向偏移
                const rayOffset = (i - Math.floor(rayCount / 2)) * raySpacing;
                let startY = centerY + rayOffset;
                let postLensY = startY;
                
                // 计算经过矫正透镜后的Y坐标
                if (currentLens !== 'none') {
                    const lensEffect = lensParams[currentLens].effect || 0;
                    const factor = Math.abs(rayOffset) / 150; // 控制折射角度
                    // 错误矫正时折射角度更大，强化视觉效果
                    const errorFactor = (
                        (currentEye === 'hyperopia' && currentLens === 'concave') || 
                        (currentEye === 'myopia' && currentLens === 'convex')
                    ) ? 1.5 : 1; // 错误组合放大1.5倍效果
                    
                    postLensY = startY + (lensEffect * factor * errorFactor / 4);
                }
                
                // 限制晶状体出射点在晶状体内
                const lensExitY = Math.max(centerY - lensHalfHeight + 8, 
                                          Math.min(centerY + lensHalfHeight - 8, postLensY));
                const lensExitX = lensX + lensHalfWidth;
                
                // 绘制入射光线（进入晶状体前）
                ctx.beginPath();
                if (currentLens !== 'none') {
                    // 从起点到矫正透镜
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(correctionLensX - correctionLensWidth / 2, startY);
                    ctx.stroke();
                    
                    // 从矫正透镜到晶状体
                    ctx.beginPath();
                    ctx.moveTo(correctionLensX + correctionLensWidth / 2, postLensY);
                    ctx.lineTo(lensExitX - lensWidth, postLensY);
                } else {
                    // 无矫正透镜：直接从起点到晶状体
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(lensExitX - lensWidth, startY);
                }
                ctx.strokeStyle = '#d1d5db'; // 淡灰色入射光
                ctx.lineWidth = 1.5;
                ctx.stroke();
                
                // 绘制折射光线（从晶状体到焦点）
                ctx.beginPath();
                ctx.moveTo(lensExitX, lensExitY);  // 晶状体右侧出射点
                ctx.lineTo(focus.x, focus.y);      // 直接连接到唯一焦点
                ctx.strokeStyle = '#f97316'; // 橙色折射光
                ctx.lineWidth = 2.5;
                ctx.stroke();
            }
            
            // 绘制焦点标记（唯一交汇点）
            ctx.beginPath();
            ctx.arc(focus.x, focus.y, 6, 0, Math.PI * 2);
            ctx.fillStyle = '#ef4444';
            ctx.fill();
            ctx.strokeStyle = '#dc2626';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('焦点', focus.x + 8, focus.y - 5);
        }
        
        // 事件监听
        normalEyeBtn.addEventListener('click', () => { currentEye = 'normal'; updateButtons(); drawEye(); });
        myopiaEyeBtn.addEventListener('click', () => { currentEye = 'myopia'; updateButtons(); drawEye(); });
        hyperopiaEyeBtn.addEventListener('click', () => { currentEye = 'hyperopia'; updateButtons(); drawEye(); });
        
        noLensBtn.addEventListener('click', () => { currentLens = 'none'; updateButtons(); drawEye(); });
        concaveLensBtn.addEventListener('click', () => { currentLens = 'concave'; updateButtons(); drawEye(); });
        convexLensBtn.addEventListener('click', () => { currentLens = 'convex'; updateButtons(); drawEye(); });
        
        // 初始化
        updateButtons();
        drawEye();
    </script>
</body>
</html>
